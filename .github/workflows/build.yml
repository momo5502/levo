name: Build

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "**"
    types: [opened, synchronize, reopened]
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify-formatting:
    name: Verify Formatting
    runs-on: ubuntu-24.04
    env:
      LLVM_VERSION: 21
    steps:
      - name: Checkout Source
        uses: actions/checkout@v6

      - name: Install Clang-format
        uses: nick-fields/retry@v3.0.2
        with:
          max_attempts: 5
          timeout_minutes: 15
          retry_wait_seconds: 60
          command: |
            wget https://apt.llvm.org/llvm.sh
            chmod +x llvm.sh
            sudo ./llvm.sh ${{ env.LLVM_VERSION }}
            sudo apt install -y clang-format-${{ env.LLVM_VERSION }}

      - name: Run clang-format check
        run: |
          cd source && find . -regex '.*\.\(cpp\|hpp\|cc\|cxx\|h\|c\)' -exec clang-format-${{ env.LLVM_VERSION }} -style=file --dry-run --Werror {} +

  build-linux:
    name: Build Linux x86_64
    runs-on: ubuntu-24.04
    # We use a clean container to avoid LLVM conflicts on the GH runner images
    container:
      image: ubuntu:24.04
    steps:
      - name: Install LLVM and build tools
        run: |
          export LLVM_VERSION=19
          apt update
          apt install --no-install-recommends -y \
            lsb-release \
            wget \
            software-properties-common \
            gnupg \
            cmake \
            ninja-build \
            python-is-python3 \
            python3-pip \
            python3-setuptools \
            python3-venv \
            git
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          ./llvm.sh $LLVM_VERSION
          apt install --no-install-recommends -y \
            llvm-$LLVM_VERSION-dev
          echo "LLVM_PREFIX=$(llvm-config-$LLVM_VERSION --prefix)" >> $GITHUB_ENV
          echo "CC=clang-$LLVM_VERSION" >> $GITHUB_ENV
          echo "CXX=clang++-$LLVM_VERSION" >> $GITHUB_ENV

      - name: Checkout Source
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Add workspace as safe directory (necessary for docker)
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Build dependencies
        run: |
          cmake -G Ninja -S dependencies -B dependencies/build -DUSE_EXTERNAL_LLVM=ON "-DCMAKE_PREFIX_PATH:FILEPATH=$LLVM_PREFIX" -DCMAKE_BUILD_TYPE=Release
          cmake --build dependencies/build

      - name: Build project
        run: |
          cmake -G Ninja -B build "-DCMAKE_PREFIX_PATH:FILEPATH=$PWD/dependencies/install" -DCMAKE_BUILD_TYPE=RelWithDebInfo
          cmake --build build

  test-linux:
    name: Test Linux x86_64
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Source
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
  
      - name: Install Ghidra
        uses: antoniovazquezblanco/setup-ghidra@v2.0.19
        with:
          version: "latest"

      - name: Download sample binary
        run: wget -q https://momo5502.com/emulator/sample.exe -O sample.exe

      - name: Run Ghidra CFG export script
        run: |
          mkdir -p /tmp/ghidra_proj
          "${{ env.GHIDRA_INSTALL_DIR }}/support/analyzeHeadless" \
            /tmp/ghidra_proj sample_project \
            -import "$GITHUB_WORKSPACE/sample.exe" \
            -postScript ExportCFG.java "$GITHUB_WORKSPACE/cfg_output.json" \
            -scriptPath "$GITHUB_WORKSPACE/ghidra_cfg"

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-24.04
    needs: [verify-formatting, build-linux, test-linux]
    if: always()
    steps:
      - uses: geekyeggo/delete-artifact@v5
        continue-on-error: true
        with:
          name: "Temp *"

      - name: Pipeline failed
        if: ${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}
        run: exit 1
